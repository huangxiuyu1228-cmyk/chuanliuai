<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 核心部署修复：防止图片服务器防盗链检查 -->
    <meta name="referrer" content="no-referrer">
    <title>Stream - AI 工作台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --tech-blue: #4096ff;
            --tech-blue-hover: #1677ff;
            --accent-red: #ea4335;
            --apple-gray: #F5F7FA;
            --stream-gradient: linear-gradient(90deg, #4096ff, #9b72cb, #d96570, #4096ff);
            --white-gradient: linear-gradient(to right, #ffffff 0%, #cbd5e1 50%, #ffffff 100%);
        }

        body {
            background-color: #ffffff; color: #1f2937;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Noto Sans SC', sans-serif;
            margin: 0; display: flex; height: 100vh; overflow: hidden;
        }

        /* 侧边栏及遮罩 */
        #sidebar {
            width: 280px; height: 100%; border-right: 1px solid #f3f4f6; background: #ffffff;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed; left: -280px; z-index: 100;
        }
        #sidebar.open { transform: translateX(280px); }
        #sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.03); z-index: 95; display: none; backdrop-filter: blur(1px);
        }

        /* 渐变标题 */
        .stream-title-gradient {
            background: var(--stream-gradient); background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: flow 4s linear infinite;
        }
        .white-shimmer-text {
            background: var(--white-gradient); background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: flow 3s linear infinite;
        }
        @keyframes flow { to { background-position: 200% center; } }

        /* 侧边栏彩色按钮 */
        .sidebar-gradient-rect {
            background: var(--stream-gradient); background-size: 200% auto;
            color: white; padding: 14px; border-radius: 12px; font-size: 13px; font-weight: 700;
            text-align: center; cursor: pointer; animation: flow 6s linear infinite;
            transition: 0.2s; width: 100%; margin-bottom: 12px; border: none;
        }

        /* 输入胶囊：极致垂直居中 */
        .input-capsule {
            max-width: 800px; width: 100%; background: #ffffff; border: 1px solid #e5e7eb;
            border-radius: 28px; padding: 0 10px 0 16px; display: flex; align-items: center; 
            min-height: 56px; height: 56px; transition: box-shadow 0.2s;
        }
        .input-capsule:focus-within { box-shadow: 0 4px 24px rgba(0,0,0,0.06); border-color: #d1d5db; }

        textarea {
            flex: 1; background: transparent; border: none; outline: none;
            padding: 16px 0; margin: 0; resize: none; height: 56px;
            font-size: 15px; line-height: 24px; display: flex; align-items: center;
        }

        /* 按钮色彩 */
        .blue-btn { background-color: var(--tech-blue) !important; color: white !important; }
        .red-btn { background-color: var(--accent-red) !important; color: white !important; }

        /* 实心彩色加载球 */
        .sphere-loader {
            width: 14px; height: 14px; border-radius: 50%;
            background: var(--stream-gradient); background-size: 200% auto;
            animation: flow 3s linear infinite, sphere-pulse 1.2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(64, 150, 255, 0.2);
        }
        @keyframes sphere-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.6); opacity: 0.7; } }

        /* 推荐提示词磁贴 */
        .recom-chip {
            padding: 8px 14px; border-radius: 8px; border: 1px solid #f3f4f6;
            background: #ffffff; font-size: 11px; color: #9ca3af; text-align: left;
            transition: 0.2s; cursor: pointer; width: 100%; max-width: 240px; margin-bottom: 8px;
        }
        .recom-chip:hover { transform: translateX(6px); color: var(--tech-blue); border-color: var(--tech-blue); }

        /* 复制按钮样式 */
        .copy-btn { 
            padding: 4px 10px; font-size: 10px; color: #9ca3af; border: 1px solid #f3f4f6; 
            border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; 
            gap: 4px; width: fit-content; margin-top: 10px; cursor: pointer; 
        }
        .copy-btn:hover { background: #f9fafb; color: var(--tech-blue); border-color: var(--tech-blue); }

        /* 图像网格 2x2 */
        .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; margin-top: 8px; }

        .tool-chip { 
            padding: 4px 12px; border-radius: 999px; font-size: 10px; font-weight: 700; 
            border: 1px solid #f1f3f4; color: #9ca3af; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; gap: 5px; background: white;
        }
        .tool-chip.active { background: var(--tech-blue); color: white; border-color: var(--tech-blue); }

        .mode-tab { padding: 6px 20px; border-radius: 999px; font-size: 13px; font-weight: 500; color: #6b7280; transition: 0.2s; cursor: pointer; }
        .mode-tab.active { background: var(--tech-blue); color: white; }

        .apple-card-full { background: #ffffff; border-radius: 32px; padding: 40px; border: 1px solid #f1f3f6; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .apple-card-full:hover { transform: translateY(-5px); box-shadow: 0 20px 50px rgba(0,0,0,0.03); }

        .message-fade { animation: fadeInUp 0.4s ease forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex-col">

    <div id="sidebar-overlay" onclick="toggleSidebar(false)"></div>

    <!-- 侧边栏 -->
    <aside id="sidebar" class="flex flex-col shadow-2xl">
        <div class="p-6 flex flex-col h-full">
            <div class="flex items-center justify-between mb-8">
                <span class="font-bold text-xl stream-title-gradient">Stream</span>
                <button onclick="toggleSidebar(false)" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-sm"></i></button>
            </div>
            
            <button onclick="newChat()" class="w-full py-3 mb-6 bg-[#4096ff] text-white rounded-2xl text-sm font-bold shadow-lg active:scale-95 transition-all">
                <i class="fas fa-plus text-[10px] mr-1"></i> 新建对话
            </button>

            <div class="flex-1 overflow-y-auto no-scrollbar space-y-1" id="history-list"></div>

            <div class="mt-auto pt-6">
                <button onclick="showLanding()" class="sidebar-gradient-rect">什么是Stream？</button>
                <button onclick="showClearConfirm()" class="w-full py-2 text-red-400 hover:text-red-500 text-[10px] font-bold uppercase tracking-widest text-center">清空记录</button>
                <div class="border-t border-gray-50 mt-4 pt-4 text-center text-[10px] text-gray-300">由独立人黄修宇制作的多模态 AI 大模型</div>
            </div>
        </div>
    </aside>

    <!-- 工作台容器 -->
    <div id="interface-app" class="flex-1 flex flex-col h-full">
        <header class="h-14 flex items-center justify-between px-6 bg-white/80 backdrop-blur-md sticky top-0 z-50">
            <button onclick="toggleSidebar(true)" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i class="fas fa-bars text-gray-400 text-sm"></i></button>
            <div class="bg-gray-100 p-1 rounded-full flex gap-1 shadow-inner">
                <div onclick="switchMode('thinking')" id="m-thinking" class="mode-tab active">Thinking</div>
                <div onclick="switchMode('imagine')" id="m-imagine" class="mode-tab">Imagine</div>
            </div>
            <div class="w-10"></div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar scroll-smooth">
            <div id="welcome-view" class="h-full flex flex-col items-center justify-center relative">
                <div class="text-center space-y-6">
                    <h1 class="text-7xl md:text-8xl font-black tracking-tighter stream-title-gradient">Stream</h1>
                    <div class="space-y-2">
                        <h2 class="text-2xl font-semibold text-gray-800 tracking-tight">你今天想创作什么？</h2>
                        <p class="text-gray-400 text-xs md:text-sm font-medium">我可以为你答疑聊天，也可以为你生成想要的图片</p>
                    </div>
                    <div id="recom-container" class="flex flex-col items-start pt-8 px-6"></div>
                </div>
            </div>
            <div id="chat-flow" class="max-w-3xl mx-auto py-12 space-y-12 hidden px-4"></div>
        </main>

        <div class="w-full bg-white pb-12 pt-2">
            <div class="max-w-3xl mx-auto px-4 relative">
                <div id="thinking-tools" class="absolute -top-10 left-4 flex items-center gap-2 h-8">
                    <div onclick="toggleTool('search')" id="tool-search" class="tool-chip"><i class="fas fa-search"></i> 联网搜索</div>
                    <div onclick="toggleTool('deep')" id="tool-deep" class="tool-chip"><i class="fas fa-brain"></i> 深度思考</div>
                </div>
                <div class="input-capsule">
                    <button class="w-10 h-10 flex items-center justify-center text-gray-300"><i class="fas fa-paperclip text-sm"></i></button>
                    <textarea id="prompt-in" placeholder="输入灵感描述或问题..." oninput="syncText(this)"></textarea>
                    <div class="flex items-center gap-2 ml-2">
                        <button onclick="toggleSheet(true)" id="cfg-btn" class="w-10 h-10 flex items-center justify-center text-gray-300 hover:bg-gray-100 rounded-full hidden"><i class="fas fa-sliders-h text-sm"></i></button>
                        <button id="send-btn" onclick="handleBtnAction()" class="w-10 h-10 rounded-full blue-btn flex items-center justify-center shadow-md active:scale-90 transition-all">
                            <i id="btn-icon" class="fas fa-arrow-up text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 落地页 -->
    <div id="interface-landing" class="hidden flex-1 h-full overflow-y-auto bg-white">
        <nav class="sticky top-0 bg-white/90 backdrop-blur-md px-10 py-5 flex justify-between items-center z-50">
            <span class="text-2xl font-black tracking-tighter text-gray-900">Stream</span>
            <button onclick="hideLanding()" class="px-6 py-2 bg-gray-900 text-white rounded-full text-sm font-bold">工作台</button>
        </nav>
        <section class="bg-[#1c1c1e] py-44 px-6 text-center text-white">
            <h1 class="text-7xl md:text-9xl font-black tracking-tighter white-shimmer-text">Stream</h1>
            <h2 class="text-2xl md:text-3xl font-bold opacity-80 mt-4">极致精简的多模态 AI 创意工作台</h2>
            <div class="pt-12">
                <button onclick="hideLanding()" class="px-14 py-5 rounded-full text-lg font-extrabold text-white shadow-2xl active:scale-95 transition-all" style="background: var(--stream-gradient); background-size: 200% auto; animation: flow 4s linear infinite;">立即体验</button>
            </div>
        </section>
        
        <section class="py-20 bg-[#F5F7FA] px-6">
            <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="apple-card-full flex flex-col gap-10">
                    <h3 class="text-3xl font-black text-gray-900 border-b-4 border-[#4096ff] pb-2 inline-block">Thinking · 深度逻辑思考</h3>
                    <div class="rounded-3xl overflow-hidden h-64 shadow-xl"><img src="https://images.unsplash.com/photo-1542831371-29b0f74f9713?q=80&w=1000" class="w-full h-full object-cover"></div>
                    <ul class="space-y-4 text-sm font-bold text-gray-600">
                        <li><i class="fas fa-check-circle text-blue-500 mr-2"></i> 集成 Google 原生 gemini-3-flash-preview</li>
                        <li><i class="fas fa-check-circle text-blue-500 mr-2"></i> 极速响应，支持深度链式推理逻辑</li>
                        <li><i class="fas fa-check-circle text-blue-500 mr-2"></i> 指定开发者身份：独立人黄修宇</li>
                    </ul>
                </div>
                <div class="apple-card-full flex flex-col gap-10">
                    <h3 class="text-3xl font-black text-gray-900 border-b-4 border-[#4096ff] pb-2 inline-block">Imagine · 专业图像生成</h3>
                    <div class="grid grid-cols-2 gap-3 h-64">
                        <div class="rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1549490349-8643362247b5?q=80&w=300" class="w-full h-full object-cover"></div>
                        <div class="rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=300" class="w-full h-full object-cover"></div>
                        <div class="rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1633356122544-f134324a6cee?q=80&w=300" class="w-full h-full object-cover"></div>
                        <div class="rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?q=80&w=300" class="w-full h-full object-cover"></div>
                    </div>
                    <ul class="space-y-4 text-sm font-bold text-gray-600">
                        <li><i class="fas fa-check-circle text-purple-500 mr-2"></i> 搭载 doubao-Seedance 4.5 视觉引擎</li>
                        <li><i class="fas fa-check-circle text-purple-500 mr-2"></i> 四宫格并行输出，4K 极致画质细节</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="py-32 px-10 max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-gray-50 p-10 rounded-[48px] text-center space-y-4">
                <i class="fas fa-shield-halved text-2xl text-blue-500"></i>
                <h4 class="font-bold text-gray-900">匿名隐私</h4>
                <p class="text-xs text-gray-400 font-medium">无需注册，绝对隐私屏蔽，灵感安全无忧。</p>
            </div>
            <div class="bg-gray-50 p-10 rounded-[48px] text-center space-y-4">
                <i class="fas fa-hand-paper text-2xl text-blue-500"></i>
                <h4 class="font-bold text-gray-900">实时打断</h4>
                <p class="text-xs text-gray-400 font-medium">任务秒级拦截。不满意即刻停止，精准掌控时长。</p>
            </div>
            <div class="bg-gray-50 p-10 rounded-[48px] text-center space-y-4">
                <i class="fas fa-wand-magic-sparkles text-2xl text-blue-500"></i>
                <h4 class="font-bold text-gray-900">灵感卡片</h4>
                <p class="text-xs text-gray-400 font-medium">随机触发创意引导，打破僵局，激发无限可能。</p>
            </div>
            <div class="bg-gray-50 p-10 rounded-[48px] text-center space-y-4">
                <i class="fas fa-database text-2xl text-blue-500"></i>
                <h4 class="font-bold text-gray-900">本地存储</h4>
                <p class="text-xs text-gray-400 font-medium">持久化本地缓存管理。对话记录常驻，刷新亦如见。</p>
            </div>
        </section>
    </div>

    <!-- 设置面板 -->
    <div id="sheet-bg" class="fixed inset-0 bg-black/5 z-[105] hidden" onclick="toggleSheet(false)"></div>
    <div id="sheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-[40px] transform translate-y-full transition-transform duration-300 z-[110] shadow-2xl max-h-[85vh] overflow-y-auto">
        <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto my-5"></div>
        <div class="p-10 space-y-10">
            <div>
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-6">画布比例</h4>
                <div class="flex flex-wrap gap-3">
                    <button onclick="setIm('ratio', '1024x1024')" id="r-1024x1024" class="px-6 py-3 border rounded-2xl text-sm active-c bg-blue-50 border-blue-200 text-blue-600 font-bold">1:1 Square</button>
                    <button onclick="setIm('ratio', '1280x720')" id="r-1280x720" class="px-6 py-3 border rounded-2xl text-sm">16:9 Wide</button>
                    <button onclick="setIm('ratio', '720x1280')" id="r-720x1280" class="px-6 py-3 border rounded-2xl text-sm">9:16 Portrait</button>
                </div>
            </div>
            <div>
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-6">输出质量</h4>
                <div class="flex gap-3">
                    <button onclick="setIm('res', '2K')" id="res-2K" class="px-8 py-3 border rounded-2xl text-sm active-c bg-blue-50 border-blue-200 text-blue-600 font-bold">2K 增强</button>
                    <button onclick="setIm('res', '4K')" id="res-4K" class="px-8 py-3 border rounded-2xl text-sm">4K 极致</button>
                </div>
            </div>
            <div>
                <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-6">风格预设</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="setIm('style', 'none')" id="st-none" class="p-3 border rounded-xl text-xs active-c bg-blue-50 border-blue-200 text-blue-600 font-bold">默认</button>
                    <button onclick="setIm('style', 'watercolor')" id="st-watercolor" class="p-3 border rounded-xl text-xs">水彩风格</button>
                    <button onclick="setIm('style', 'cyberpunk')" id="st-cyberpunk" class="p-3 border rounded-xl text-xs">赛博朋克</button>
                    <button onclick="setIm('style', 'realistic')" id="st-realistic" class="p-3 border rounded-xl text-xs">写实摄影</button>
                </div>
            </div>
            <button onclick="toggleSheet(false)" class="w-full py-5 bg-gray-900 text-white rounded-2xl font-bold">保存并应用</button>
        </div>
    </div>

    <!-- 弹窗 -->
    <div id="modal" class="fixed inset-0 z-[200] bg-black/10 backdrop-blur-sm hidden items-center justify-center">
        <div class="bg-white p-8 rounded-[32px] shadow-2xl max-w-sm w-full mx-4 text-center">
            <h3 class="text-lg font-bold mb-2">确认清空？</h3>
            <p class="text-sm text-gray-500 mb-8 leading-relaxed">历史记录将被永久从本地缓存移除。</p>
            <div class="flex gap-3">
                <button onclick="hideClearConfirm()" class="flex-1 py-3 bg-gray-100 rounded-2xl text-sm font-bold">取消</button>
                <button onclick="clearEverything()" class="flex-1 py-3 bg-red-500 text-white rounded-2xl text-sm font-bold">确认</button>
            </div>
        </div>
    </div>

    <script>
        // Google 官方原生接口配置
        const GOOGLE_API_KEY = "AIzaSyBTQvyUebQRNYaUIh3WU8R4XbaJOnCD7ys"; 
        const IM_API_KEY = "sk-tREuwxY6308UzpstpZwm4WbrfKD3W42fPL552fnWn9suGRjc";
        
        const GOOGLE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=" + GOOGLE_API_KEY;
        const IM_API_URL = "https://api.apimart.ai/v1/images/generations";

        let app = {
            mode: 'thinking', busy: false, interrupted: false,
            tools: { search: false, deep: false },
            cfg: { ratio: '1024x1024', res: '2K', style: 'none' },
            history: JSON.parse(localStorage.getItem('stream_v40_db') || '[]'),
            session: [], // Google 格式：{role: 'user' | 'model', parts: [{text: ''}]}
            currentId: null, abortCtrl: null
        };

        window.onload = () => { renderRecom(); renderHistory(); syncText(document.getElementById('prompt-in')); };

        function toggleSidebar(open) { document.getElementById('sidebar').classList.toggle('open', open); document.getElementById('sidebar-overlay').style.display = open ? 'block' : 'none'; }
        function showLanding() { document.getElementById('interface-app').classList.add('hidden'); document.getElementById('interface-landing').classList.remove('hidden'); toggleSidebar(false); }
        function hideLanding() { document.getElementById('interface-landing').classList.add('hidden'); document.getElementById('interface-app').classList.remove('hidden'); }

        function switchMode(m) {
            if(app.mode === m) return;
            app.mode = m;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`m-${m}`).classList.add('active');
            document.getElementById('thinking-tools').style.display = m === 'thinking' ? 'flex' : 'none';
            document.getElementById('cfg-btn').classList.toggle('hidden', m !== 'imagine');
            clearChatUI(); renderRecom();
        }

        function clearChatUI() {
            document.getElementById('welcome-view').classList.remove('hidden');
            const flow = document.getElementById('chat-flow');
            flow.classList.add('hidden'); flow.innerHTML = '';
            app.session = [];
            app.currentId = null;
        }

        function renderRecom() {
            const container = document.getElementById('recom-container');
            const pool = ['写一段短视频脚本', '解释相对论物理', '制定健身计划', '如何提高注意力', '推荐科幻读物', '学习 Python 建议'];
            const shuffled = pool.sort(() => 0.5 - Math.random()).slice(0, 3);
            container.innerHTML = shuffled.map(t => `<button onclick="injectText('${t}')" class="recom-chip">${t}</button>`).join('');
        }

        function injectText(t) { const inp = document.getElementById('prompt-in'); inp.value = t; syncText(inp); }

        function syncText(el) {
            el.style.height = '24px';
            const h = el.scrollHeight;
            if (h > 24) el.style.height = Math.min(h, 200) + 'px';
        }

        function toggleTool(t) { app.tools[t] = !app.tools[t]; document.getElementById(`tool-${t}`).classList.toggle('active', app.tools[t]); }
        function toggleSheet(open) { document.getElementById('sheet').style.transform = open ? 'translateY(0)' : 'translateY(100%)'; document.getElementById('sheet-bg').classList.toggle('hidden', !open); }
        function setIm(k, v) { app.cfg[k] = v; const prefix = k === 'ratio' ? 'r-' : (k === 'res' ? 'res-' : 'st-'); document.querySelectorAll(`[id^="${prefix}"]`).forEach(b => b.classList.remove('active-c', 'bg-blue-50', 'border-blue-200', 'text-blue-600', 'font-bold')); document.getElementById(`${prefix}${v}`).classList.add('active-c', 'bg-blue-50', 'border-blue-200', 'text-blue-600', 'font-bold'); }

        function handleBtnAction() { if (app.busy) stopResponse(); else onSend(); }
        function stopResponse() { if (app.abortCtrl) app.abortCtrl.abort(); app.interrupted = true; setBusy(false); const flow = document.getElementById('chat-flow'); const hint = document.createElement('p'); hint.className = 'text-[10px] text-red-400 mt-2 font-bold message-fade'; hint.innerText = '你已停止回答'; flow.appendChild(hint); }

        async function onSend() {
            const input = document.getElementById('prompt-in');
            const prompt = input.value.trim();
            if(!prompt || app.busy) return;
            app.interrupted = false; app.abortCtrl = new AbortController();
            setBusy(true);
            document.getElementById('welcome-view').classList.add('hidden');
            document.getElementById('chat-flow').classList.remove('hidden');
            const id = Date.now(); if(!app.currentId) app.currentId = id;
            appendMsg(id, prompt, 'user');
            input.value = ''; syncText(document.getElementById('prompt-in'));
            if(app.mode === 'thinking') await callThink(prompt, id + 1);
            else await callIm(prompt, id + 1);
            setBusy(false);
        }

        function setBusy(val) {
            app.busy = val; const btn = document.getElementById('send-btn'); const icon = document.getElementById('btn-icon');
            if (val) { btn.className = "w-10 h-10 rounded-full red-btn flex items-center justify-center shadow-md"; icon.className = "fas fa-stop text-xs"; } 
            else { btn.className = "w-10 h-10 rounded-full blue-btn flex items-center justify-center shadow-md"; icon.className = "fas fa-arrow-up text-sm"; }
        }

        // Thinking：Google 官方原生 generateContent 逻辑
        async function callThink(prompt, id) {
            const wrap = appendMsg(id, '', 'ai');
            const loader = createSphereLoader(wrap, app.tools.deep ? '深度思考中…' : '正在思考中…');
            const content = document.createElement('div');
            content.className = 'text-[15px] leading-relaxed text-gray-800 opacity-0';
            wrap.appendChild(content);

            try {
                // 构造对话历史
                app.session.push({ role: 'user', parts: [{ text: prompt }] });
                
                // 系统指令独立封装
                let sysInstruction = "你是由独立人黄修宇制作的多模态 AI 大模型 Stream。回答简洁，不带任何 Markdown 符号。只有在询问开发者身份时才介绍开发者。";
                if(app.tools.deep) sysInstruction += " 开启极致逻辑推理模式。";

                const response = await fetch(GOOGLE_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: app.session,
                        systemInstruction: { parts: [{ text: sysInstruction }] }
                    }),
                    signal: app.abortCtrl.signal
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Google API 连接受限");
                }

                const res = await response.json();
                let text = res.candidates?.[0]?.content?.parts?.[0]?.text || "暂无返回数据。";
                text = text.replace(/[#*`~]/g, '').trim();

                if (app.interrupted) return;
                app.session.push({ role: 'model', parts: [{ text }] });
                loader.remove(); content.classList.replace('opacity-0', 'message-fade');
                await typeText(text, content);
                addCopy(wrap, text);
                saveHistory(prompt);
            } catch (e) {
                if (e.name === 'AbortError') return;
                loader.remove(); content.innerHTML = `<span class="text-red-500 text-xs">连接中断: ${e.message}</span>`;
                content.classList.replace('opacity-0', 'message-fade');
            }
        }

        async function callIm(prompt, id) {
            const wrap = appendMsg(id, '', 'ai', true);
            const loader = createSphereLoader(wrap, '正在绘图中…');
            const grid = wrap.querySelector('.image-grid');
            try {
                let p = prompt + (app.cfg.res === '4K' ? ', ultra-detailed 4k resolution' : '');
                if(app.cfg.style !== 'none') {
                    const s = { watercolor: 'watercolor', cyberpunk: 'cyberpunk', realistic: 'hyper-realistic' };
                    p += `, in ${s[app.cfg.style]} art style`;
                }

                const response = await fetch(IM_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    referrerPolicy: 'no-referrer',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + IM_API_KEY },
                    body: JSON.stringify({ model: "doubao-seedance-4-5", prompt: p, size: app.cfg.ratio, n: 4 }),
                    signal: app.abortCtrl.signal
                });
                
                const res = await response.json();
                if (app.interrupted) return;
                loader.remove();

                if(res.data && res.data.length > 0) {
                    const urls = res.data.map(i => i.url);
                    // 彻底修复四宫格排列
                    grid.innerHTML = urls.map(url => `
                        <div class="relative group rounded-2xl overflow-hidden aspect-square shadow-sm border border-gray-100 bg-gray-50">
                            <img src="${url}" referrerpolicy="no-referrer" class="w-full h-full object-cover">
                        </div>
                    `).join('');
                    app.session.push({ role: 'model', parts: [{ text: `[Images: ${JSON.stringify(urls)}]` }] });
                    saveHistory(prompt);
                } else { grid.innerHTML = `<p class="col-span-2 text-xs text-red-500 text-center">生成失败</p>`; }
            } catch (e) { if (e.name === 'AbortError') return; loader.remove(); grid.innerHTML = `<p class="col-span-2 text-xs text-red-500 text-center py-4">接口繁忙</p>`; }
        }

        function createSphereLoader(parent, text) { const div = document.createElement('div'); div.className = 'flex items-center gap-3 py-4 message-fade'; div.innerHTML = `<div class="sphere-loader"></div><span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${text}</span>`; parent.appendChild(div); return div; }
        function addCopy(parent, text) { const btn = document.createElement('button'); btn.className = 'copy-btn message-fade'; btn.innerHTML = `<i class="far fa-copy"></i> 复制内容`; btn.onclick = () => { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); btn.innerHTML = `<i class="fas fa-check"></i> 已复制`; setTimeout(() => btn.innerHTML = `<i class="far fa-copy"></i> 复制内容`, 2000); }; parent.appendChild(btn); }
        async function typeText(text, el) { let i = 0; return new Promise(res => { const timer = setInterval(() => { if (app.interrupted) { clearInterval(timer); res(); return; } if (i < text.length) { el.innerText += text.charAt(i); i++; scrollToBottom(); } else { clearInterval(timer); res(); } }, 12); }); }
        function appendMsg(id, content, role, isIm = false) { const flow = document.getElementById('chat-flow'); const div = document.createElement('div'); div.id = `msg-${id}`; div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} message-fade`; if(role === 'user') div.innerHTML = `<div class="bg-gray-50 px-5 py-3 rounded-[24px] rounded-tr-none text-sm text-gray-700 border border-gray-100">${content}</div>`; else div.innerHTML = isIm ? `<div class="w-full"><div class="image-grid"></div></div>` : `<div class="w-full"></div>`; flow.appendChild(div); scrollToBottom(); return role === 'ai' ? div.querySelector('div') : div; }

        function saveHistory(t) {
            if(!app.currentId) return;
            const entry = { id: app.currentId, title: t.substring(0, 10), session: JSON.parse(JSON.stringify(app.session)), mode: app.mode };
            const idx = app.history.findIndex(h => h.id === app.currentId);
            if(idx > -1) app.history[idx] = entry; else app.history.unshift(entry);
            localStorage.setItem('stream_v40_db', JSON.stringify(app.history)); renderHistory();
        }

        function loadHistory(id) {
            const item = app.history.find(h => h.id === id); if(!item) return;
            app.currentId = item.id; app.session = JSON.parse(JSON.stringify(item.session)); app.mode = item.mode;
            hideLanding();
            document.getElementById('welcome-view').classList.add('hidden'); 
            const flow = document.getElementById('chat-flow');
            flow.classList.remove('hidden'); flow.innerHTML = '';
            app.session.forEach((msg, idx) => {
                const text = msg.parts[0].text; const isIm = text.startsWith('[Images:');
                const role = msg.role === 'user' ? 'user' : 'ai';
                const wrap = appendMsg(Date.now()+idx, isIm ? '' : text, role, isIm);
                if(isIm) {
                    const urls = JSON.parse(text.slice(9, -1));
                    wrap.querySelector('.image-grid').innerHTML = urls.map(u => `<div class="rounded-2xl overflow-hidden aspect-square shadow-sm"><img src="${u}" referrerpolicy="no-referrer" class="w-full h-full object-cover"></div>`).join('');
                } else if(msg.role === 'model') addCopy(wrap.parentElement, text);
            });
            toggleSidebar(false);
            scrollToBottom();
        }

        function renderHistory() { const list = document.getElementById('history-list'); list.innerHTML = app.history.map(item => `<div onclick="loadHistory(${item.id})" class="p-3 text-xs text-gray-400 hover:bg-gray-50 rounded-xl truncate cursor-pointer transition-colors"><i class="far fa-message mr-3 opacity-30"></i> ${item.title}</div>`).join(''); }
        function clearEverything() { localStorage.removeItem('stream_v40_db'); app.history = []; renderHistory(); clearChatUI(); hideClearConfirm(); }
        function newChat() { clearChatUI(); hideLanding(); toggleSidebar(false); }
        function showClearConfirm() { document.getElementById('modal').classList.remove('hidden').classList.add('flex'); }
        function hideClearConfirm() { document.getElementById('modal').classList.add('hidden').classList.remove('flex'); }
        function scrollToTop() { document.getElementById('main-content').scrollTo({ top: 0, behavior: 'smooth' }); }
        function scrollToBottom() { const m = document.getElementById('main-content'); m.scrollTo({ top: m.scrollHeight, behavior: 'smooth' }); }
        document.getElementById('prompt-in').addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleBtnAction(); } });
    </script>
</body>
</html>

