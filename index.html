<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>川流 - Chuanliu AI V3.1</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --apple-blue: #0071E3;
            --apple-bg: #F5F5F7;
            --apple-font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", "PingFang SC", sans-serif;
        }

        body {
            font-family: var(--apple-font);
            background-color: var(--apple-bg);
            color: #1D1D1F;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        /* High-end Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: saturate(210%) blur(40px);
            -webkit-backdrop-filter: saturate(210%) blur(40px);
        }

        /* Layer Management */
        header { z-index: 50; }
        #sidebar { z-index: 100; transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1); }
        #sidebarOverlay { z-index: 90; background: rgba(0, 0, 0, 0.15); backdrop-filter: blur(10px); transition: opacity 0.5s ease; }
        .footer-bar { z-index: 50; }

        /* Welcome Prompt Animation */
        .prompt-fade { transition: opacity 0.8s ease, transform 0.8s ease, filter 0.8s ease; will-change: opacity, transform, filter; }
        .prompt-hidden { opacity: 0; transform: translateY(12px); filter: blur(10px); }
        .prompt-visible { opacity: 1; transform: translateY(0); filter: blur(0); }

        /* Bubble Aesthetics */
        .bubble-user { background: var(--apple-blue); color: white; border-radius: 22px 22px 4px 22px; box-shadow: 0 4px 15px rgba(0,113,227,0.15); }
        .bubble-ai { 
            background: #ffffff; 
            border: 1px solid rgba(210,210,217,0.4); 
            border-radius: 22px 22px 22px 4px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.03); 
            position: relative;
            z-index: 1; 
        }

        /* Linear Edge Marquee: Low frequency 5s cycle */
        @keyframes linearGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        .is-thinking::before {
            content: "";
            position: absolute;
            inset: -2px; 
            z-index: -1;
            padding: 2px; 
            background: linear-gradient(90deg, #4285F4, #9B72CB, #D96570, #F4AF40, #4285F4);
            background-size: 200% 100%;
            border-radius: 24px 24px 24px 6px;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            -webkit-mask-composite: xor;
            animation: linearGlow 5s linear infinite;
        }

        /* Thinking Sequential Fade-in */
        @keyframes lineAppear {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 0.65; transform: translateY(0); }
        }
        .thought-line {
            display: block;
            opacity: 0;
            animation: lineAppear 0.8s ease forwards;
            font-style: italic;
            font-size: 13px;
            color: #424245;
            line-height: 1.7;
        }

        /* Logo Morph Animation */
        @keyframes logoMorph {
            0%, 100% { border-radius: 24px; transform: translateY(0) scale(1); box-shadow: 0 12px 30px rgba(0, 113, 227, 0.25); }
            35% { border-radius: 50%; transform: translateY(-35px) scale(0.85); box-shadow: 0 25px 45px rgba(0, 113, 227, 0.15); }
            70% { border-radius: 50%; transform: translateY(8px) scale(0.92); box-shadow: 0 5px 15px rgba(0, 113, 227, 0.2); }
        }
        .chuanliu-logo-wrapper { width: 84px; height: 120px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 12px; }
        .chuanliu-logo {
            width: 84px; height: 84px;
            background: linear-gradient(135deg, #0071E3 0%, #00C7FF 100%);
            display: flex; align-items: center; justify-content: center;
            animation: logoMorph 5s cubic-bezier(0.45, 0, 0.55, 1) infinite;
            overflow: hidden;
        }
        .logo-circle { width: 32px; height: 32px; border: 3.5px solid white; border-radius: 50%; opacity: 0.9; }

        .markdown-body pre { background: #1D1D1F !important; border-radius: 16px; padding: 1.25rem; margin: 1.25rem 0; border: none; overflow-x: auto; }
        .markdown-body code { font-family: "SF Mono", "Fira Code", monospace; font-size: 13px; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .input-pill { background: rgba(242, 242, 247, 0.85); border: 1px solid rgba(210, 210, 217, 0.5); border-radius: 32px; transition: all 0.3s ease; }
        .input-pill:focus-within { background: #FFFFFF; border-color: var(--apple-blue); box-shadow: 0 0 0 5px rgba(0, 113, 227, 0.08); }

        #modelMenu {
            left: 50%; transform: translateX(-50%);
            animation: appleMenuIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transform-origin: top center;
        }
        @keyframes appleMenuIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px) scale(0.96); }
            to { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }

        .guide-viewport { width: 100%; height: 420px; position: relative; overflow: hidden; touch-action: pan-y; }
        .guide-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 40px; border-radius: 36px;
            opacity: 0; transform: translateX(100%) scale(0.9); transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex; flex-direction: column; justify-content: flex-start; pointer-events: none;
            border: 1px solid rgba(255,255,255,0.4); box-shadow: inset 0 0 40px rgba(255,255,255,0.1);
        }
        .guide-card.active { opacity: 1; transform: translateX(0) scale(1); pointer-events: auto; }
        .guide-card.prev { opacity: 0; transform: translateX(-100%) scale(0.9); }

        .bg-card-flash { background: radial-gradient(circle at 100% 100%, rgba(0, 113, 227, 0.3) 0%, #ffffff 85%); }
        .bg-card-thinking { background: radial-gradient(circle at 100% 100%, rgba(175, 82, 222, 0.3) 0%, #ffffff 85%); }
        .bg-card-creative { background: radial-gradient(circle at 100% 100%, rgba(255, 149, 0, 0.3) 0%, #ffffff 85%); }

        .indicator-dot { width: 6px; height: 6px; border-radius: 50%; background: #D2D2D7; transition: all 0.4s ease; }
        .indicator-dot.active { width: 24px; border-radius: 3px; background: var(--apple-blue); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="sidebarOverlay" class="fixed inset-0 sidebar-overlay opacity-0 pointer-events-none" onclick="toggleSidebar(false)"></div>

    <!-- Sidebar Menu -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 glass border-r border-gray-200/40 -translate-x-full flex flex-col shadow-2xl">
        <div class="p-6 pt-16 flex flex-col h-full">
            <h3 class="text-xs font-bold text-[#86868B] uppercase tracking-[0.2em] mb-8 px-2">控制中心</h3>
            <div class="space-y-2">
                <button onclick="newChat()" class="w-full flex items-center space-x-3 p-4 rounded-2xl bg-white text-[#0071E3] font-semibold shadow-sm active:scale-95 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2.5" stroke-linecap="round"/></svg>
                    <span>开启新对话</span>
                </button>
                <div class="pt-6 pb-2 px-2 text-[11px] font-bold text-gray-400 uppercase tracking-widest">历史足迹</div>
                <div id="historyList" class="space-y-1 max-h-[50vh] overflow-y-auto no-scrollbar py-1 text-left"></div>
            </div>
            <div class="mt-auto pt-6 border-t border-gray-100/60 text-center pb-8">
                <p class="text-[12px] text-gray-900 font-bold tracking-tight mb-6">川流智能体 V3.1</p>
                <button onclick="clearAllHistory()" class="w-full flex items-center space-x-3 p-4 rounded-2xl text-red-500 font-medium active:scale-95 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5" stroke-linecap="round"/></svg>
                    <span>清空本地足迹</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Top Navigation -->
    <header class="fixed top-0 w-full glass border-b border-gray-200/30 px-4 h-14 flex items-center justify-between">
        <button onclick="toggleSidebar(true)" class="p-2.5 text-[#1D1D1F] active:scale-90 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke-width="2.5" stroke-linecap="round"/></svg>
        </button>

        <div class="relative">
            <button onclick="toggleModelMenu()" class="flex items-center space-x-2 px-5 py-2 bg-[#F2F2F7] hover:bg-[#E8E8ED] rounded-full text-[14px] font-bold text-[#1D1D1F] active:scale-95 transition-all shadow-sm border border-gray-200/20">
                <div id="activeModelIndicator" class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                <span id="activeModelLabel">川流 Flash</span>
                <svg class="w-3 h-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            
            <div id="modelMenu" class="hidden absolute top-12 w-64 glass rounded-[32px] shadow-2xl border border-gray-200/50 p-2.5">
                <button onclick="changeModel('flash')" class="w-full flex items-center space-x-4 p-4 hover:bg-white/80 rounded-2xl transition-all mb-1 group text-left">
                    <div class="w-9 h-9 bg-blue-500 text-white rounded-xl flex items-center justify-center shadow-md"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2.2"/></svg></div>
                    <div class="flex flex-col"><span class="text-sm font-bold">川流 Flash</span><span class="text-[10px] text-gray-400 font-medium">极致响应 · 视觉分析</span></div>
                </button>
                <button onclick="changeModel('thinking')" class="w-full flex items-center space-x-4 p-4 hover:bg-white/80 rounded-2xl transition-all mb-1 group text-left">
                    <div class="w-9 h-9 bg-purple-600 text-white rounded-xl flex items-center justify-center shadow-md"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2.2"/></svg></div>
                    <div class="flex flex-col"><span class="text-sm font-bold">川流 Thinking</span><span class="text-[10px] text-gray-400 font-medium">深度推演 · 视觉识别</span></div>
                </button>
                <button onclick="changeModel('creative')" class="w-full flex items-center space-x-4 p-4 hover:bg-white/80 rounded-2xl transition-all group text-left">
                    <div class="w-9 h-9 bg-orange-500 text-white rounded-xl flex items-center justify-center shadow-md"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2.2"/></svg></div>
                    <div class="flex flex-col"><span class="text-sm font-bold">川流 Creative</span><span class="text-[10px] text-gray-400 font-medium">视觉艺术 · 灵感绘图</span></div>
                </button>
            </div>
        </div>

        <button onclick="toggleModal(true)" class="px-3.5 py-1.5 bg-[#F2F2F7] text-[#0071E3] text-[13px] font-bold rounded-full active:scale-95 transition-transform">指南</button>
    </header>

    <!-- Main Chat Viewport -->
    <main id="chatContainer" class="flex-grow overflow-y-auto pt-20 pb-32 px-4 no-scrollbar relative">
        <div class="max-w-3xl mx-auto w-full" id="messageList">
            <!-- Initial Welcome -->
            <div id="welcome" class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-fade-in px-6">
                <div class="chuanliu-logo-wrapper">
                    <div class="chuanliu-logo">
                        <div class="logo-circle"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <h2 class="text-3xl font-bold tracking-tight text-[#1D1D1F]">你好，我是川流！</h2>
                    <h2 class="text-3xl font-bold tracking-tight text-[#1D1D1F]">Hello, I am Chuanliu!</h2>
                    <div class="h-10 flex items-center justify-center overflow-hidden pt-4">
                        <div id="promptWrapper" class="prompt-fade prompt-visible"><p id="typedPrompt" class="text-xl font-semibold"></p></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Input Column -->
    <div class="footer-bar fixed bottom-0 w-full glass border-t border-gray-200/30 pb-[calc(1.2rem+env(safe-area-inset-bottom))] pt-4 px-4">
        <div class="max-w-4xl mx-auto relative">
            <div id="imagePreview" class="hidden absolute bottom-20 left-0 animate-fade-in">
                <div class="relative"><img id="previewImg" src="" class="h-20 w-20 object-cover rounded-2xl shadow-xl ring-4 ring-white"><button onclick="clearImage()" class="absolute -top-2 -right-2 bg-black text-white rounded-full p-1.5 shadow-md active:scale-110"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="3"/></svg></button></div>
            </div>
            <div class="input-pill px-4 py-2.5 flex items-end space-x-2">
                <label id="uploadBtn" class="mb-2 p-2.5 text-[#86868B] hover:text-[#0071E3] cursor-pointer transition-colors active:scale-90"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="1.8"/></svg><input type="file" class="hidden" id="fileIn" onchange="previewFile(this)"></label>
                <textarea id="userInput" rows="1" placeholder="输入你的问题" class="flex-grow bg-transparent border-none focus:ring-0 text-[17px] py-3 resize-none max-h-48 min-h-[46px] leading-relaxed no-scrollbar" oninput="autoGrow(this)"></textarea>
                <button id="sendBtn" onclick="handleSend()" class="p-3 bg-[#0071E3] text-white rounded-full hover:bg-[#0077ED] active:scale-90 shadow-lg shadow-blue-500/10 transition-all disabled:opacity-20"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round"/></svg></button>
            </div>
        </div>
    </div>

    <!-- Ability Center Modal -->
    <div id="guideModal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/25 backdrop-blur-sm hidden">
        <div class="bg-white/95 w-full max-w-md rounded-[44px] shadow-2xl overflow-hidden animate-in zoom-in duration-300">
            <div class="p-8 pb-4 flex justify-between items-center relative z-20">
                <h3 class="text-2xl font-extrabold tracking-tight">能力中心</h3>
                <button onclick="toggleModal(false)" class="text-[#86868B] hover:text-black transition-colors bg-[#F5F5F7] p-1.5 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
            </div>
            <div id="guideViewport" class="guide-viewport">
                <div class="guide-card bg-card-flash active" data-index="0">
                    <div class="w-16 h-16 bg-blue-600 text-white rounded-[24px] flex items-center justify-center shadow-xl shadow-blue-600/30 mb-10"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2.2"/></svg></div>
                    <div class="space-y-4 pr-4"><h4 class="text-3xl font-black tracking-tight text-[#1D1D1F]">极致响应</h4><p class="text-[16px] text-gray-700 leading-relaxed font-medium">秒级反馈。由 Google Gemini 2.5 驱动，支持超大型图像识别与多轮上下文对话。</p></div>
                </div>
                <div class="guide-card bg-card-thinking" data-index="1">
                    <div class="w-16 h-16 bg-purple-600 text-white rounded-[24px] flex items-center justify-center shadow-xl shadow-purple-600/30 mb-10"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2.2"/></svg></div>
                    <div class="space-y-4 pr-4"><h4 class="text-3xl font-black tracking-tight text-[#1D1D1F]">深度推理</h4><p class="text-[16px] text-gray-700 leading-relaxed font-medium">思维推演。原生支持视觉资产分析，拥有强大的多轮记忆能力，完整展现逻辑路径。</p></div>
                </div>
                <div class="guide-card bg-card-creative" data-index="2">
                    <div class="w-16 h-16 bg-orange-500 text-white rounded-[24px] flex items-center justify-center shadow-xl shadow-orange-600/30 mb-10"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2.2"/></svg></div>
                    <div class="space-y-4 pr-4"><h4 class="text-3xl font-black tracking-tight text-[#1D1D1F]">灵感绘图</h4><p class="text-[16px] text-gray-700 leading-relaxed font-medium">描述想象。基于 DALL-E 3 顶尖引擎，一键将文字想象转化为专业级视觉杰作。</p></div>
                </div>
            </div>
            <div class="flex justify-center space-x-3 pb-12">
                <div class="indicator-dot active" data-index="0"></div>
                <div class="indicator-dot" data-index="1"></div>
                <div class="indicator-dot" data-index="2"></div>
            </div>
            <div class="px-10 pb-10 border-t border-gray-100 pt-6 text-center bg-[#F5F5F7]/40">
                <p class="text-[12px] text-[#1D1D1F] font-bold">仅用于学习交流，著作权人黄修宇</p>
                <p class="text-[10px] text-gray-400 font-normal uppercase tracking-widest mt-1">© 2025 Chuanliu AI Intelligent Agent V3.1</p>
            </div>
        </div>
    </div>

    <script>
        const GEMINI_KEY = ""; 
        const CUSTOM_KEY = "sk-085mho9BQvutzhgEXTLuSvHRaCtdqgMqwyFShqIHJt7CUK2W";
        const CUSTOM_CHAT_URL = "https://gptapi.asia/v1/chat/completions";
        const CUSTOM_IMAGE_URL = "https://gptapi.asia/v1/images/generations";

        // Context Engine: Storage for multi-turn conversations
        let conversationHistory = []; // {role: 'user' | 'assistant', content: string, hasImage: bool}
        
        let currentModel = 'flash';
        let currentImgBase64 = null;
        let isProcessing = false;

        const colorfulPrompts = [
            { text: "“写一段优雅的 Python 爬虫”", color: "#4285F4" },
            { text: "“分析这张截图里的 UI 逻辑”", color: "#34A853" },
            { text: "“画一个赛博朋克风格的未来上海”", color: "#EA4335" },
            { text: "“如何用第一性原理思考商业？”", color: "#FBBC05" },
            { text: "“润色这段文案至学术大师水准”", color: "#AF52DE" }
        ];

        let pIdx = 0;
        function rotatePrompts() {
            const wrapper = document.getElementById('promptWrapper');
            const el = document.getElementById('typedPrompt');
            if(!el || !wrapper) return;
            wrapper.classList.remove('prompt-visible');
            wrapper.classList.add('prompt-hidden');
            setTimeout(() => {
                const item = colorfulPrompts[pIdx];
                el.innerText = item.text; el.style.color = item.color;
                pIdx = (pIdx + 1) % colorfulPrompts.length;
                wrapper.classList.remove('prompt-hidden');
                wrapper.classList.add('prompt-visible');
            }, 800);
        }
        setInterval(rotatePrompts, 4800);
        window.onload = () => { rotatePrompts(); loadHistory(); };

        // Guide Interaction: 3s rotation + swipe
        let guideInterval = null, guideIndex = 0, startX = 0;
        const guideViewport = document.getElementById('guideViewport');
        guideViewport.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        guideViewport.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            if (startX - endX > 40) nextGuide(); if (endX - startX > 40) prevGuide();
        });
        function startGuideRotation() { if(guideInterval) clearInterval(guideInterval); guideInterval = setInterval(nextGuide, 3000); }
        function nextGuide() { guideIndex = (guideIndex + 1) % 3; updateGuideCard(guideIndex); resetGuideTimer(); }
        function prevGuide() { guideIndex = (guideIndex - 1 + 3) % 3; updateGuideCard(guideIndex); resetGuideTimer(); }
        function resetGuideTimer() { clearInterval(guideInterval); guideInterval = setInterval(nextGuide, 3000); }
        function updateGuideCard(index) {
            const cards = document.querySelectorAll('.guide-card'), dots = document.querySelectorAll('.indicator-dot');
            cards.forEach((c, i) => { c.classList.remove('active', 'prev'); if (i === index) c.classList.add('active'); if (i === (index-1+3)%3) c.classList.add('prev'); });
            dots.forEach((d, i) => d.classList.toggle('active', i === index));
        }

        function toggleModelMenu() { document.getElementById('modelMenu').classList.toggle('hidden'); }
        function changeModel(m) {
            currentModel = m;
            const labels = { 'flash': '川流 Flash', 'thinking': '川流 Thinking', 'creative': '川流 Creative' };
            const colors = { 'flash': '#3b82f6', 'thinking': '#a855f7', 'creative': '#f97316' };
            document.getElementById('activeModelLabel').innerText = labels[m];
            document.getElementById('activeModelIndicator').style.backgroundColor = colors[m];
            document.getElementById('userInput').placeholder = m === 'creative' ? '描述你想画的画面...' : '输入你的问题';
            toggleModelMenu();
        }

        function toggleSidebar(show) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.style.transform = show ? 'translateX(0)' : 'translateX(-100%)';
            overlay.style.opacity = show ? '1' : '0'; overlay.style.pointerEvents = show ? 'auto' : 'none';
            if(show) renderHistory();
        }

        function toggleModal(show) { 
            const modal = document.getElementById('guideModal');
            modal.classList.toggle('hidden', !show); 
            if(show) { guideIndex = 0; updateGuideCard(0); startGuideRotation(); } else { clearInterval(guideInterval); }
        }
        
        function autoGrow(el) { el.style.height = "46px"; el.style.height = (el.scrollHeight) + "px"; }
        function previewFile(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImgBase64 = e.target.result.split(',')[1];
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
        function clearImage() { currentImgBase64 = null; document.getElementById('fileIn').value = ''; document.getElementById('imagePreview').classList.add('hidden'); }

        function copyToClipboard(text, btn) {
            const ta = document.createElement("textarea"); ta.value = text;
            document.body.appendChild(ta); ta.select();
            if (document.execCommand('copy')) {
                const old = btn.innerHTML; btn.innerHTML = `<span class="text-[11px] font-bold text-green-500">已复制</span>`;
                setTimeout(() => { btn.innerHTML = old; }, 2000);
            }
            document.body.removeChild(ta);
        }

        function appendUI(role, content, type = 'text', thoughts = null) {
            const list = document.getElementById('messageList'), welcome = document.getElementById('welcome');
            if (welcome) welcome.remove();
            const wrap = document.createElement('div');
            wrap.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-8 animate-fade-in relative`;
            const inner = document.createElement('div');
            
            if (type === 'image') {
                inner.className = `max-w-[90%] p-2 bg-white rounded-[28px] border shadow-xl overflow-hidden`;
                inner.innerHTML = `<img src="${content}" class="w-full h-auto rounded-[20px]"><div class="p-3 flex justify-between items-center"><span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">DALL-E 3 生成</span><a href="${content}" target="_blank" class="text-xs text-apple-blue font-bold">查看原图</a></div>`;
            } else {
                inner.className = `max-w-[90%] p-4 ${role === 'user' ? 'bubble-user' : 'bubble-ai'} text-[16px] leading-relaxed group`;
                if (role === 'user') inner.innerText = content;
                else if (content === 'loading') { 
                    inner.id = 'tempAI'; 
                    inner.classList.add('is-thinking'); 
                    inner.innerHTML = `<div class="text-[11px] text-[#86868B] font-bold tracking-tight">川流不息思考中...</div>`; 
                } else {
                    let html = '';
                    if (thoughts) {
                        const lines = thoughts.split('\n').filter(l => l.trim());
                        const animatedThoughts = lines.map((line, idx) => `<span class="thought-line" style="animation-delay: ${idx * 0.15}s">${line}</span>`).join('');
                        html += `<details open class="mb-4 bg-[#F5F5F7] rounded-2xl border border-gray-100 p-4 transition-all"><summary class="text-xs font-bold text-[#86868B] cursor-pointer outline-none select-none">思考路径</summary><div class="mt-3 leading-relaxed">${animatedThoughts}</div></details>`;
                    }
                    html += `<div class="markdown-body">${marked.parse(content)}</div><div class="mt-3 pt-2 border-t border-gray-50 flex justify-end opacity-0 group-hover:opacity-100 transition-opacity"><button class="copy-btn p-1 text-gray-400 hover:text-apple-blue" onclick="copyToClipboard(\`${content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, this)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="2"/></svg></button></div>`;
                    inner.innerHTML = html;
                }
            }
            wrap.appendChild(inner); list.appendChild(wrap);
            document.getElementById('chatContainer').scrollTo({ top: document.getElementById('chatContainer').scrollHeight, behavior: 'smooth' });
            return inner;
        }

        async function handleSend() {
            const input = document.getElementById('userInput'), text = input.value.trim();
            if ((!text && !currentImgBase64) || isProcessing) return;
            isProcessing = true; document.getElementById('sendBtn').disabled = true;
            
            // Display User Message
            appendUI('user', text || "[多轮多模态分析]");
            appendUI('model', 'loading');

            const cacheText = text, cacheImg = currentImgBase64;
            input.value = ''; input.style.height = '46px'; clearImage();

            try {
                let aiResponse = "", thoughts = null, type = 'text';

                if (currentModel === 'flash') {
                    // Flash (Gemini): Mapping conversation history to Gemini 'contents' format
                    const geminiMessages = conversationHistory.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'model',
                        parts: [{ text: msg.content }]
                    }));
                    
                    // Current Message Parts
                    const currentParts = [{ text: cacheText || "请解析该视觉内容。" }];
                    if (cacheImg) currentParts.push({ inlineData: { mimeType: "image/png", data: cacheImg } });
                    geminiMessages.push({ role: "user", parts: currentParts });

                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ 
                            contents: geminiMessages, 
                            systemInstruction: { parts: [{ text: "你叫川流。请直接、连贯地回答用户的问题，保持对话的上下文，不要输出思考路径。" }] } 
                        })
                    });
                    const d = await res.json(); aiResponse = d.candidates?.[0]?.content?.parts?.[0]?.text || "响应超时。";

                } else if (currentModel === 'thinking') {
                    // Thinking (DeepSeek): Mapping history to OpenAI 'messages' format
                    const dsMessages = conversationHistory.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));

                    // Current Message with Multimodal Support
                    let content = cacheImg ? [
                        { type: "text", text: cacheText || "分析此图内容并结合前文回答。" }, 
                        { type: "image_url", image_url: { url: `data:image/png;base64,${cacheImg}` } }
                    ] : cacheText;
                    
                    dsMessages.push({ role: "user", content: content });

                    const res = await fetch(CUSTOM_CHAT_URL, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CUSTOM_KEY}` },
                        body: JSON.stringify({ model: "deepseek-reasoner", messages: dsMessages })
                    });
                    const d = await res.json(); 
                    if (d.choices && d.choices[0]) {
                        aiResponse = d.choices[0].message.content; 
                        thoughts = d.choices[0].message.reasoning_content || null;
                    } else { throw new Error("API 响应失败"); }

                } else if (currentModel === 'creative') {
                    const res = await fetch(CUSTOM_IMAGE_URL, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CUSTOM_KEY}` },
                        body: JSON.stringify({ model: "dall-e-3", prompt: cacheText, n: 1, size: "1024x1024" })
                    });
                    const d = await res.json(); aiResponse = d.data[0].url; type = 'image';
                }

                // Update UI
                const temp = document.getElementById('tempAI');
                if (temp) { temp.classList.remove('is-thinking'); temp.parentElement.remove(); }
                appendUI('model', aiResponse, type, thoughts);

                // Update Context History (excluding image generation)
                if (type !== 'image') {
                    conversationHistory.push({ role: 'user', content: cacheText || "[图片上传]" });
                    conversationHistory.push({ role: 'assistant', content: aiResponse });
                    // Keep history within limit (approx 15 turns)
                    if (conversationHistory.length > 30) conversationHistory = conversationHistory.slice(-30);
                }

                saveLocal(cacheText || "对话记忆足迹");
            } catch (err) {
                const ind = document.getElementById('tempAI'); if(ind) ind.innerHTML = `<div class="text-red-500 font-bold p-3">错误: ${err.message}</div>`;
            } finally { isProcessing = false; document.getElementById('sendBtn').disabled = false; document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el)); }
        }

        function saveLocal(t) {
            let s = JSON.parse(localStorage.getItem('chuanliu_db_v3.1_context')) || [];
            s.unshift({ t: t.substring(0, 18), d: new Date().toLocaleDateString() });
            localStorage.setItem('chuanliu_db_v3.1_context', JSON.stringify(s.slice(0, 20)));
        }
        function renderHistory() {
            const c = document.getElementById('historyList'), s = JSON.parse(localStorage.getItem('chuanliu_db_v3.1_context')) || [];
            c.innerHTML = s.length ? s.map(i => `<div class="px-4 py-3 text-[13px] text-gray-500 hover:text-apple-blue truncate bg-white/40 rounded-xl mb-1 border-b border-gray-50/50 cursor-pointer transition-colors">${i.t}</div>`).join('') : `<p class="px-3 py-2 text-xs text-gray-400 italic">暂无本地记录</p>`;
        }
        window.newChat = function() {
            conversationHistory = []; currentImgBase64 = null;
            document.getElementById('messageList').innerHTML = `
                <div id="welcome" class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-8 animate-fade-in px-6">
                    <div class="chuanliu-logo-wrapper">
                        <div class="chuanliu-logo"><div class="logo-circle"></div></div>
                    </div>
                    <div class="space-y-2">
                        <h2 class="text-3xl font-bold tracking-tight text-[#1D1D1F]">你好，我是川流！</h2>
                        <h2 class="text-3xl font-bold tracking-tight text-[#1D1D1F]">Hello, I am Chuanliu!</h2>
                        <div class="h-10 flex items-center justify-center overflow-hidden pt-4">
                            <div id="promptWrapper" class="prompt-fade prompt-visible"><p id="typedPrompt" class="text-xl font-semibold"></p></div>
                        </div>
                    </div>
                </div>`;
            rotatePrompts(); toggleSidebar(false);
        }
        window.clearAllHistory = function() { localStorage.removeItem('chuanliu_db_v3.1_context'); renderHistory(); newChat(); }
        document.getElementById('userInput').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && window.innerWidth > 768) { e.preventDefault(); handleSend(); }});
    </script>
</body>
</html>

